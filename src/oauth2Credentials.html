<script type="text/html" data-template-name="oauth2Credentials">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="oauth2Credentials.label.name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]oauth2Credentials.placeholder.name" style="width:70%;" />
    </div>
    <div class="form-row">
        <label for="node-config-input-grant_type"><i class="fa fa-wrench"></i> <span data-i18n="oauth2Credentials.label.grant_type"></span></label>
        <select id="node-config-input-grant_type" style="width:70%;">
            <option value="client_credentials" data-i18n="oauth2Credentials.opts.client_credentials"></option>
            <option value="password" data-i18n="oauth2Credentials.opts.password"></option>
            <option value="authorization_code" data-i18n="oauth2Credentials.opts.authorization_code"></option>
        </select>
    </div>
    <div class="form-row input-error" id="node-access_token_url">
        <label for="node-config-input-access_token_url"><i class="fa fa-link fa-fw"></i> <span data-i18n="oauth2Credentials.label.access_token_url"></span></label>
        <input type="text" id="node-config-input-access_token_url" data-i18n="[placeholder]oauth2Credentials.placeholder.access_token_url" style="width:70%;" />
    </div>
    <div class="form-row" id="node-authorization_endpoint">
        <label for="node-config-input-authorization_endpoint"><i class="fa fa-link fa-fw"></i> <span data-i18n="oauth2Credentials.label.authorization_endpoint"></span></label>
        <input type="text" id="node-config-input-authorization_endpoint" data-i18n="[placeholder]oauth2Credentials.placeholder.authorization_endpoint" style="width:70%;" />
    </div>
    <div class="form-row" id="node-password_credentials">
        <div class="form-row">
            <label for="node-config-input-username"><i class="fa fa-user fa-fw"></i> <span data-i18n="oauth2Credentials.label.username"></span></label>
            <input type="text" id="node-config-input-username" data-i18n="[placeholder]oauth2Credentials.placeholder.username" style="width:70%;" />
        </div>
        <div class="form-row">
            <label for="node-config-input-password"><i class="fa fa-lock fa-fw"></i> <span data-i18n="oauth2Credentials.label.password"></span></label>
            <input type="password" id="node-config-input-password" data-i18n="[placeholder]oauth2Credentials.placeholder.password" style="width:70%;" />
        </div>
    </div>
    <div class="form-row" id="node-client_id">
        <label for="node-config-input-client_id"><i class="fa fa-user fa-fw"></i> <span data-i18n="oauth2Credentials.label.client_id"></span></label>
        <input type="text" id="node-config-input-client_id" data-i18n="[placeholder]oauth2Credentials.placeholder.client_id" style="width:70%;" />
    </div>
    <div class="form-row" id="node-client_secret">
        <label for="node-config-input-client_secret"><i class="fa fa-lock fa-fw"></i> <span data-i18n="oauth2Credentials.label.client_secret"></span></label>
        <input type="password" id="node-config-input-client_secret" data-i18n="[placeholder]oauth2Credentials.placeholder.client_secret" style="width:70%;" />
    </div>
    <div class="form-row" id="node-scope">
        <label for="node-config-input-scope"><i class="fa fa-code fa-fw"></i> <span data-i18n="oauth2Credentials.label.scope"></span></label>
        <input type="text" id="node-config-input-scope" data-i18n="[placeholder]oauth2Credentials.placeholder.scope" style="width:70%;" />
    </div>
    <div class="form-row" id="node-resource">
        <label for="node-config-input-resource"><i class="fa fa-code fa-fw"></i> <span data-i18n="oauth2Credentials.label.resource"></span></label>
        <input type="text" id="node-config-input-resource" data-i18n="[placeholder]oauth2Credentials.placeholder.resource" style="width:70%;" />
    </div>
    <div class="form-row" id="node-open_authentication">
        <label for="node-config-input-open_authentication"><i class="fa fa-sign-in fa-fw"></i> <span data-i18n="oauth2Credentials.label.open_authentication"></span></label>
        <a class="red-ui-button fa fa-key" id="authorizeButton" href="#" target="_blank"></a>
        <input type="text" id="node-config-input-open_authentication" data-i18n="[placeholder]oauth2Credentials.placeholder.open_authentication" style="width:62%;margin-top: -2px;" disabled />
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType('oauth2Credentials', {
        category: 'config',
        color: '#fff',
        icon: 'oauth2.svg',
        label: function () {
            return this.name;
        },
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        defaults: {
            name: {
                value: ''
            },
            grant_type: {
                value: 'client_credentials',
                required: true,
                validate: function (v) { return ['client_credentials', 'password', 'authorization_code'].includes(v); }
            },
            access_token_url: {
                value: '',
                required: true,
                validate: function (v) { return v.length > 0 && /^(https?:\/\/)/.test(v); }
            },
            authorization_endpoint: {
                value: '',
                validate: function (v) { return $('#node-config-input-grant_type').val() === 'authorization_code' ? v.length > 0 && /^(https?:\/\/)/.test(v) : true; }
            },
            redirect_uri: {
                value: '/oauth2/redirect_uri',
                validate: function (v) { return $('#node-config-input-grant_type').val() === 'authorization_code' ? v.length > 0 : true; }
            },
            open_authentication: {
                value: ''
            },
            username: {
                value: '',
                validate: function (v) { return $('#node-config-input-grant_type').val() === 'password' ? v.length > 0 : true; }
            },
            password: {
                value: '',
                validate: function (v) { return $('#node-config-input-grant_type').val() === 'password' ? v.length > 0 : true; }
            },
            client_id: {
                value: '',
                required: true,
                validate: function (v) { return v.length > 0; }
            },
            client_secret: {
                value: '',
                required: true,
                validate: function (v) { return v.length > 0; }
            },
            scope: {
                value: ''
            },
            resource: {
                value: '',
                required: true,
                validate: function (v) { return v.length > 0; }
            }
        },
        credentials: {
            grant_type: { type: 'text' },
            access_token_url: { type: 'text' },
            authorization_endpoint: { type: 'text' },
            redirect_uri: { type: 'text' },
            open_authentication: { type: 'text' },
            username: { type: 'text' },
            password: { type: 'password' },
            client_id: { type: 'text' },
            client_secret: { type: 'password' },
            scope: { type: 'text' },
            resource: { type: 'text' }
        },

        oneditprepare: function () {
            const elementMapping = {
                client_credentials: [
                    '#node-access_token_url',
                    '#node-client_id',
                    '#node-client_secret',
                    '#node-scope',
                    '#node-resource'
                ],
                password: [
                    '#node-password_credentials',
                    '#node-access_token_url',
                    '#node-client_id',
                    '#node-client_secret',
                    '#node-scope',
                    '#node-resource'
                ],
                authorization_code: [
                    '#node-open_authentication',
                    '#node-redirect_uri',
                    '#node-access_token_url',
                    '#node-authorization_endpoint',
                    '#node-client_id',
                    '#node-client_secret',
                    '#node-scope',
                    '#node-resource'
                ]
            };

            function updateVisibilityAndMarkErrors() {
                const grantType = $('#node-config-input-grant_type').val();
                if (!elementMapping[grantType]) {
                    RED.notify(`Invalid grant_type: ${grantType}`);
                    return;
                }

                // Hide all elements
                for (const key in elementMapping) {
                    elementMapping[key].forEach((selector) => $(selector).hide());
                }

                // Show relevant elements
                elementMapping[grantType].forEach((selector) => $(selector).show());

                // Mark fields with errors
                const markFieldError = (selector, validateFn) => {
                    const field = $(selector);
                    if (field.length === 0) return; // Skip marking if field does not exist
                    const value = field.val();
                    if (validateFn(value)) {
                        field.removeClass('input-error');
                    } else {
                        field.addClass('input-error');
                    }
                };

                markFieldError('#node-config-input-grant_type', (v) => ['client_credentials', 'password', 'authorization_code'].includes(v));
                markFieldError('#node-config-input-access_token_url', (v) => v.length > 0 && /^(https?:\/\/)/.test(v));

                if (grantType === 'authorization_code') {
                    markFieldError('#node-config-input-authorization_endpoint', (v) => v.length > 0 && /^(https?:\/\/)/.test(v));
                    markFieldError('#node-config-input-redirect_uri', (v) => v.length > 0);
                }

                if (grantType === 'password') {
                    markFieldError('#node-config-input-username', (v) => v.length > 0);
                    markFieldError('#node-config-input-password', (v) => v.length > 0);
                }

                markFieldError('#node-config-input-client_id', (v) => v.length > 0);
                markFieldError('#node-config-input-client_secret', (v) => v.length > 0);
                markFieldError('#node-config-input-resource', (v) => v.length > 0);

                RED.tray.resize();
            }

            $('input, select').on('blur change keyup', updateVisibilityAndMarkErrors);
            $('#node-config-input-grant_type').on('change', updateVisibilityAndMarkErrors);

            if (!$('#node-config-input-grant_type').val()) {
                $('#node-config-input-grant_type').val('client_credentials'); // Set default value
            }
            updateVisibilityAndMarkErrors(); // Initial visibility and error marking
        },
        oneditsave: function () {
            function validateField(selector, validateFn) {
                const field = $(selector);
                if (field.length === 0) return true; // Skip validation if field does not exist
                const value = field.val();
                if (validateFn(value)) {
                    field.removeClass('input-error');
                    return true;
                } else {
                    field.addClass('input-error');
                    return false;
                }
            }

            function validateFields() {
                const grantType = $('#node-config-input-grant_type').val();
                let valid = true;

                valid = validateField('#node-config-input-grant_type', (v) => ['client_credentials', 'password', 'authorization_code'].includes(v)) && valid;
                valid = validateField('#node-config-input-access_token_url', (v) => v.length > 0 && /^(https?:\/\/)/.test(v)) && valid;

                if (grantType === 'authorization_code') {
                    valid = validateField('#node-config-input-authorization_endpoint', (v) => v.length > 0 && /^(https?:\/\/)/.test(v)) && valid;
                    valid = validateField('#node-config-input-redirect_uri', (v) => v.length > 0) && valid;
                }

                if (grantType === 'password') {
                    valid = validateField('#node-config-input-username', (v) => v.length > 0) && valid;
                    valid = validateField('#node-config-input-password', (v) => v.length > 0) && valid;
                }

                valid = validateField('#node-config-input-client_id', (v) => v.length > 0) && valid;
                valid = validateField('#node-config-input-client_secret', (v) => v.length > 0) && valid;
                valid = validateField('#node-config-input-resource', (v) => v.length > 0) && valid;

                return valid;
            }

            // Se o campo name estiver vazio, preencher com o valor de grant_type
            const nameField = $('#node-config-input-name');
            const grantType = $('#node-config-input-grant_type').val();
            if (nameField.val().trim() === '') {
                const translatedText = this._(`oauth2Credentials.opts.${grantType}`);
                nameField.val(translatedText);
            }

            if (!validateFields()) {
                RED.notify("Please correct the errors in the form", "error");
                return false; // Prevent save if there are invalid fields
            }
        }
    });
</script>